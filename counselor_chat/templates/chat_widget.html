<div id="chat-box">
    <!-- messages will be appended here -->
</div>

<form id="chat-form">
    {% csrf_token %}
    <input type="text" id="chat-input" name="message" placeholder="Say something..." required>
    <button type="submit">Send</button>
</form>

<style>
    #chat-box {
        width: 100%;
        max-width: 10000px;
        margin: 20px auto;
        padding: 10px;
        background-color: #e6ca84;
        border-radius: 10px;
        overflow-y: auto;
        max-height: 400px;
        scroll-behavior: smooth;
    }

    #chat-box .user {
        background-color: #9DF7E5;
        color: #000000;
        text-align: left;
        border-radius: 10px;
        padding: 10px;
        margin: 5px 0;
        max-width: 35%;
        margin-left: 60%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #chat-box .assistant {
        background-color: #D66BA0;
        color: #ffff;
        text-align: left;
        border-radius: 10px;
        padding: 10px;
        margin: 5px 0;
        max-width: 55%;
        margin-right: 40%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .timestamp {
        font-size: 0.8em;
        color: #888;
        margin-left: 10px;
        text-align: right;
        display: block;
    }

    #chat-box .user:hover, #chat-box .assistant:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.3s ease;
    }
</style>

<!-- Markdown-it for parsing -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<!-- DOMPurify for sanitizing the generated HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

<script>
let isCoolDown = false;
const chatDelay = 1500;

const tutoringSubject = "{{ subject|default:'' }}";

document.addEventListener('DOMContentLoaded', () => {
  const pageIdentifier = "{{ page_identifier }}";

  const md = markdownit({ html: false, linkify: true, typographer: true });

  loadChatHistory(pageIdentifier);

  document.getElementById('chat-form').addEventListener('submit', async e => {
    e.preventDefault();
    if (isCoolDown) return alert('Please wait a few seconds before sending another message.');

    const inputEl = document.getElementById('chat-input');
    const message = inputEl.value.trim();
    if (!message) return;

    isCoolDown = true;
    setTimeout(() => { isCoolDown = false; }, chatDelay);

    appendToChat(message, 'user');

    const aiResp = await fetch("{% url 'counselor_chat:chat' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `message=${encodeURIComponent(message)}&page_identifier=${encodeURIComponent(pageIdentifier)}&subject=${encodeURIComponent(tutoringSubject)}`
    });
    const { reply } = await aiResp.json();

    appendToChat(reply, 'assistant');

    inputEl.value = '';
  });

  function appendToChat(text, sender) {
    const chatBox = document.getElementById('chat-box');
    const msgDiv = document.createElement('div');
    msgDiv.className = sender;

    let rawHtml = md.render(text);
    let safeHtml = DOMPurify.sanitize(rawHtml);

    msgDiv.innerHTML = `
      <span class="message">${safeHtml}</span>
      <span class="timestamp">${new Date().toLocaleTimeString()}</span>
    `;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function loadChatHistory(pageIdentifier) {
    const url = "{% url 'counselor_chat:get_chat_history' %}"
      + `?page_identifier=${encodeURIComponent(pageIdentifier)}`;
    try {
      const res = await fetch(url, { credentials: 'include' });
      if (!res.ok) throw new Error('Network error');
      const { messages } = await res.json();
      messages.forEach(m => appendToChat(m.message, m.role));
    } catch (err) {
      console.error("Failed to load chat history:", err);
    }
  }

  async function saveChatMessage(message, role, pageIdentifier) {
    try {
      await fetch("{% url 'counselor_chat:save_chat_message' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message, role, page_identifier: pageIdentifier })
      });
    } catch (err) {
      console.error("Error saving message:", err);
    }
  }
});
</script>
