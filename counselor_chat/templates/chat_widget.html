<div class="card  shadow-sm mb-3" >
  <div class="card-header bg-custom " style="background-color: #af4d98; color: #fef8e6;">
    Counselor Pablo
  </div>
  <div class="card-body p-3" id="chat-box" style="background-color: #dccea2; max-height: 400px; overflow-y: auto;">
    <!-- messages will be appended here -->
  </div>
  <div class="card-footer" style="background-color: #af4d98;">
    <form id="chat-form" class="d-flex">
      {% csrf_token %}
      <input type="text" id="chat-input" name="message" class="form-control me-2" placeholder="Say something..." required>
      <button type="submit" class="btn btn-custom" style="background-color: #9df7e5; color:#ffff;">Send</button>
    </form>
  </div>
</div>


<style>
  #chat-box .user {
      background-color: #9DF7E5;
      color: #000;
      border-radius: 10px;
      padding: 10px;
      margin: 5px 0;
      max-width: 70%;
      margin-left: auto;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  #chat-box .assistant {
      background-color: #D66BA0;
      color: #fff;
      border-radius: 10px;
      padding: 10px;
      margin: 5px 0;
      max-width: 70%;
      margin-right: auto;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  .timestamp {
      font-size: 0.75em;
      color: #6c757d;
      text-align: right;
      display: block;
      margin-top: 5px;
  }

  #chat-box .user:hover,
  #chat-box .assistant:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.3s ease;
  }
</style>

<!-- Markdown-it for parsing -->
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<!-- DOMPurify for sanitizing the generated HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

<script>
let isCoolDown = false;
const chatDelay = 1500;

const tutoringSubject = "{{ subject|default:'' }}";

document.addEventListener('DOMContentLoaded', () => {
  const pageIdentifier = "{{ page_identifier }}";

  const md = markdownit({ html: false, linkify: true, typographer: true });

  loadChatHistory(pageIdentifier);

  document.getElementById('chat-form').addEventListener('submit', async e => {
    e.preventDefault();
    if (isCoolDown) return alert('Please wait a few seconds before sending another message.');

    const inputEl = document.getElementById('chat-input');
    const message = inputEl.value.trim();
    inputEl.value = '';
    if (!message) return;

    isCoolDown = true;
    setTimeout(() => { isCoolDown = false; }, chatDelay);

    appendToChat(message, 'user');

    const aiResp = await fetch("{% url 'counselor_chat:chat' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `message=${encodeURIComponent(message)}&page_identifier=${encodeURIComponent(pageIdentifier)}&subject=${encodeURIComponent(tutoringSubject)}`
    });
    const { reply } = await aiResp.json();

    appendToChat(reply, 'assistant');

    inputEl.value = '';
  });

  function appendToChat(text, sender, timestamp) {
    const chatBox = document.getElementById('chat-box');
    const msgDiv = document.createElement('div');
    msgDiv.className = sender;

    let rawHtml = md.render(text);
    let safeHtml = DOMPurify.sanitize(rawHtml);

    msgDiv.innerHTML = `
      <span class="message">${safeHtml}</span>
      <span class="timestamp">${timestamp}</span>
    `;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function loadChatHistory(pageIdentifier) {
    const url = "{% url 'counselor_chat:get_chat_history' %}"
      + `?page_identifier=${encodeURIComponent(pageIdentifier)}`;
    try {
      const res = await fetch(url, { credentials: 'include' });
      if (!res.ok) throw new Error('Network error');
      const { messages } = await res.json();
      messages.forEach(m => appendToChat(m.message, m.role, m.timestamp));
    } catch (err) {
      console.error("Failed to load chat history:", err);
    }
  }
});
</script>
