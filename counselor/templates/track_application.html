{% extends 'base.html' %}

{% block title %}Track Application{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Tracking Application for {{ application.college }}</h2>

    <form method="POST" class="mb-4 p-4 bg-light rounded border">
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label">Major:</label>
            <input type="text" class="form-control" name="major" value="{{ application.major }}">
        </div>

        <div class="mb-3">
            <label class="form-label">Alt Major:</label>
            <input type="text" class="form-control" name="alt_major" value="{{ application.alt_major }}">
        </div>

        <div class="mb-3">
            <label class="form-label">Application Type:</label>
            <select class="form-select" name="application_type">
                {% for val, label in application.TYPE %}
                    <option value="{{ val }}" {% if val == application.application_type %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Chance Level:</label>
            <select class="form-select" name="chance">
                {% for val, label in application.CHANCE %}
                    <option value="{{ val }}" {% if val == application.chance %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Deadline:</label>
            <input type="date" class="form-control" name="deadline" value="{{ application.deadline|date:'Y-m-d' }}">
        </div>

        <div class="mb-3">
            <label class="form-label">Location:</label>
            <select class="form-select" name="location">
                {% for val, label in application.LOCATION %}
                    <option value="{{ val }}" {% if val == application.location %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="rec_letter_status" value="2" {% if application.rec_letter_status == 2 %}checked{% endif %}>
            <label class="form-check-label">Recommendation Letter Complete</label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="general_questions_status" value="2" {% if application.general_questions_status == 2 %}checked{% endif %}>
            <label class="form-check-label">General Questions Complete</label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="grade_report_status" value="2" {% if application.grade_report_status == 2 %}checked{% endif %}>
            <label class="form-check-label">Grade Report Complete</label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="SAT_ACT_score_status" value="2" {% if application.SAT_ACT_score_status == 2 %}checked{% endif %}>
            <label class="form-check-label">SAT/ACT Scores Complete</label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="scholarship_application_status" value="2" {% if application.scholarship_application_status == 2 %}checked{% endif %}>
            <label class="form-check-label">Scholarship Application Complete</label>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="FAFSA_application_status" value="2" {% if application.FAFSA_application_status == 2 %}checked{% endif %}>
            <label class="form-check-label">FAFSA Application Complete</label>
        </div>

        <p class="fw-bold">
            Current Status: 
            {% if application.application_status == 2 %}
                <span class="text-success">Submitted</span>
            {% else %}
                <span class="text-warning">In Progress</span>
            {% endif %}
        </p>

        <button type="submit" class="btn btn-primary">Save Tracking Info</button>
    </form>

    {% if application.application_status != 2 %}
        <form method="POST" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="mark_finished" value="1">
            <button type="submit" class="btn btn-success">Mark as Finished</button>
        </form>
    {% endif %}

    <hr>

    <h3>Essay Drafts</h3>
    {% for draft in essay_drafts %}
        <form method="POST" class="mb-4 p-3 border rounded bg-white">
            {% csrf_token %}
            <input type="hidden" name="edit_draft_id" value="{{ draft.id }}">

            <div class="mb-2">
                <label class="form-label">Prompt:</label>
                <textarea class="form-control" name="prompt" rows="2">{{ draft.prompt }}</textarea>
            </div>

            <div class="mb-2">
                <label class="form-label">Draft:</label>
                <div class="essay-feedback form-control" contenteditable="true" data-draft-id="{{ draft.id }}">{{ draft.draft|safe }}</div>
                <input type="hidden" name="draft" class="draft-hidden-input">
            </div>

            <button type="submit" name="save_draft_only" value="1" class="btn btn-secondary">Save Changes</button>
        </form>
    {% endfor %}

    <h3>Add New Essay Draft</h3>
    <form method="POST" class="p-3 border bg-light rounded">
        {% csrf_token %}
        <div class="mb-3">
            <label class="form-label">Prompt:</label>
            <textarea name="prompt" class="form-control" rows="2"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Draft:</label>
            <textarea name="draft" class="form-control" rows="6"></textarea>
        </div>

        <button type="submit" name="save_draft_only" value="1" class="btn btn-success">Add Draft</button>
    </form>
</div>

{% include 'chat_widget.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing essay analyzer...');
        
            const originalContents = new Map();
        
            document.querySelectorAll('.essay-feedback').forEach(essayDiv => {
                originalContents.set(essayDiv, essayDiv.innerHTML);
        
                const button = document.createElement('button');
                button.textContent = 'Analyze Essay';
                button.className = 'analyze-btn';
                button.style.cssText = `
                    display: block;
                    margin-top: 10px;
                    padding: 8px 15px;
                    background: #4CAF50;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                `;
                essayDiv.parentNode.insertBefore(button, essayDiv.nextSibling);
        
                button.addEventListener('click', async function(event) {
                    event.preventDefault(); // âœ… Prevent page reload
                    await analyzeAndRenderEssay(essayDiv);
                });
            });
        
            async function analyzeAndRenderEssay(essayDiv) {
                const originalContent = originalContents.get(essayDiv);
                const text = essayDiv.innerText.trim();
        
                if (text.length < 10) {
                    showError('Please enter at least 10 characters');
                    return;
                }
        
                essayDiv.innerHTML = '<div class="loading-message">Analyzing your essay... <div class="spinner"></div></div>';
        
                try {
                    console.log('Starting analysis...');
        
                    const startTime = Date.now();
                    const response = await fetch("{% url 'counselor:analyze_essay' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({ text: text })
                    });
                    console.log(`Request completed in ${Date.now() - startTime}ms`);
        
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Server error:', response.status, errorText);
                        throw new Error(`Server error: ${response.status}`);
                    }
        
                    const result = await response.json();
                    console.log('Analysis results:', result);
        
                    if (!result.highlights || !Array.isArray(result.highlights)) {
                        throw new Error('Invalid response format');
                    }
        
                    renderAnalyzedContent(essayDiv, originalContent, result.highlights);
        
                } catch (error) {
                    console.error('Analysis failed:', error);
                    essayDiv.innerHTML = originalContent;
                    showError(getUserErrorMessage(error));
                }
            }
        
            function renderAnalyzedContent(container, originalContent, highlights) {
                const newContent = document.createElement('div');
                newContent.innerHTML = originalContent;
        
                highlights.forEach(item => {
                    if (!item.text) return;
                    try {
                        const regex = new RegExp(escapeRegExp(item.text), 'gi');
                        highlightTextNodes(newContent, regex, item.suggestion);
                    } catch (e) {
                        console.warn('Failed to highlight:', item.text, e);
                    }
                });
        
                container.innerHTML = newContent.innerHTML;
                initTooltips(container);
            }
        
            function highlightTextNodes(element, regex, suggestion) {
                const treeWalker = document.createTreeWalker(
                    element,
                    NodeFilter.SHOW_TEXT,
                    { acceptNode: node => node.nodeValue.trim().length > 0 }
                );
        
                const nodes = [];
                while (treeWalker.nextNode()) nodes.push(treeWalker.currentNode);
        
                nodes.forEach(node => {
                    const newHtml = node.nodeValue.replace(
                        regex,
                        `<span class="highlight-visible" data-tooltip="${escapeHtml(suggestion || '')}">$&</span>`
                    );
        
                    if (newHtml !== node.nodeValue) {
                        const wrapper = document.createElement('span');
                        wrapper.innerHTML = newHtml;
                        node.parentNode.replaceChild(wrapper, node);
                    }
                });
            }
        
            function initTooltips(container) {
                container.querySelectorAll('.highlight-visible').forEach(hl => {
                    hl.addEventListener('mouseenter', showTooltip);
                    hl.addEventListener('mouseleave', hideTooltip);
                });
            }
        
            function showTooltip(e) {
                const tooltip = document.createElement('div');
                tooltip.className = 'essay-tooltip';
                tooltip.textContent = this.dataset.tooltip;
        
                const rect = this.getBoundingClientRect();
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.top + window.scrollY - 5}px`;
                tooltip.style.transform = 'translateY(-100%)';
        
                document.body.appendChild(tooltip);
                this._tooltip = tooltip;
            }
        
            function hideTooltip() {
                if (this._tooltip) {
                    this._tooltip.remove();
                    delete this._tooltip;
                }
            }
        
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = message;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }
        
            function getUserErrorMessage(error) {
                if (error.message.includes('CSRF')) return 'Session expired. Please refresh.';
                if (error.message.includes('status 500')) return 'Server error. Try again later.';
                if (error.message.includes('status 404')) return 'Service unavailable.';
                return error.message || 'Analysis failed. Please try again.';
            }
        });
        document.querySelectorAll('form').forEach(form => {
            const draftDiv = form.querySelector('.essay-feedback');
            const hiddenInput = form.querySelector('.draft-hidden-input');

            if (draftDiv && hiddenInput) {
                form.addEventListener('submit', () => {
                    hiddenInput.value = draftDiv.innerHTML.trim();
                });
            }
        });

        </script>
        
        
        <style>
        /* GUARANTEED VISIBLE STYLES */
        .highlight-visible {
            background-color: #ff0 !important;
            border-bottom: 2px solid #f90 !important;
            padding: 0 2px !important;
            border-radius: 3px !important;
            cursor: help;
        }
        
        /* LOADING STATE */
        .loading-message {
            color: #666;
            font-style: italic;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* TOOLTIPS */
        .essay-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        
        /* ERROR MESSAGE */
        .error-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        </style>
{% endblock %}