{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Application</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Main Styles */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h2, h3 {
            color: #2c3e50;
        }
        
        form {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        textarea {
            min-height: 100px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        hr {
            margin: 20px 0;
            border: 0;
            border-top: 1px solid #eee;
        }
        
        /* Essay Draft Styles */
        .essay-feedback {
            min-height: 200px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
        }
        
        /* Highlight Tooltip Styles */
        .highlight-tooltip {
            background-color: #FFEB3B;
            border-bottom: 1px dashed #FF5722;
            cursor: help;
            position: relative;
        }
        
        .highlight-tooltip:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            white-space: nowrap;
            z-index: 100;
            min-width: 200px;
            max-width: 400px;
        }
        
        /* Status Colors */
        .status-complete {
            color: green;
        }
        
        .status-in-progress {
            color: orange;
        }
    </style>
</head>
<body>
    <h2>Tracking Application for {{ application.college }}</h2>

    <form method="POST">
        {% csrf_token %}

        <label>Major:</label>
        <input type="text" name="major" value="{{ application.major }}">

        <label>Alt Major:</label>
        <input type="text" name="alt_major" value="{{ application.alt_major }}">

        <label>Application Type:</label>
        <select name="application_type">
            {% for val, label in application.TYPE %}
                <option value="{{ val }}" {% if val == application.application_type %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>

        <label>Chance Level:</label>
        <select name="chance">
            {% for val, label in application.CHANCE %}
                <option value="{{ val }}" {% if val == application.chance %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>

        <label>Deadline:</label>
        <input type="date" name="deadline" value="{{ application.deadline|date:'Y-m-d' }}">

        <label>Location:</label>
        <select name="location">
            {% for val, label in application.LOCATION %}
                <option value="{{ val }}" {% if val == application.location %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>

        <!-- Status Checkboxes -->
        <label><input type="checkbox" name="rec_letter_status" value="2" {% if application.rec_letter_status == 2 %}checked{% endif %}> Recommendation Letter Complete</label>

        <label><input type="checkbox" name="general_questions_status" value="2" {% if application.general_questions_status == 2 %}checked{% endif %}> General Questions Complete</label>

        <label><input type="checkbox" name="grade_report_status" value="2" {% if application.grade_report_status == 2 %}checked{% endif %}> Grade Report Complete</label>

        <label><input type="checkbox" name="SAT_ACT_score_status" value="2" {% if application.SAT_ACT_score_status == 2 %}checked{% endif %}> SAT/ACT Scores Complete</label>

        <label><input type="checkbox" name="scholarship_application_status" value="2" {% if application.scholarship_application_status == 2 %}checked{% endif %}> Scholarship Application Complete</label>

        <label><input type="checkbox" name="FAFSA_application_status" value="2" {% if application.FAFSA_application_status == 2 %}checked{% endif %}> FAFSA Application Complete</label>

        <p><strong>Current Status:</strong> 
            {% if application.application_status == 2 %}
                <span class="status-complete">Submitted</span>
            {% else %}
                <span class="status-in-progress">In Progress</span>
            {% endif %}
        </p>

        <button type="submit">Save Tracking Info</button>
    </form>

    {% if application.application_status != 2 %}
        <form method="POST" style="margin-top: 20px;">
            {% csrf_token %}
            <input type="hidden" name="mark_finished" value="1">
            <button type="submit">Mark as Finished</button>
        </form>
    {% endif %}

    <hr>

    <h3>Essay Drafts</h3>
    {% for draft in essay_drafts %}
        <form method="POST" style="border: 1px solid #ccc; padding: 10px; margin-bottom: 20px;">
            {% csrf_token %}
            <input type="hidden" name="edit_draft_id" value="{{ draft.id }}">
            <label>Prompt:</label>
            <textarea name="prompt" rows="2" cols="100">{{ draft.prompt }}</textarea>

            <label>Draft:</label>
            <div class="essay-feedback" contenteditable="true" data-draft-id="{{ draft.id }}">{{ draft.draft|safe }}</div>
            <input type="hidden" name="draft" class="draft-hidden-input">

            <button type="submit" name="save_draft_only" value="1">Save Changes</button>
        </form>
    {% endfor %}

    <!-- Add New Draft -->
    <h3>Add New Essay Draft</h3>
    <form method="POST">
        {% csrf_token %}
        <label>Prompt:</label>
        <textarea name="prompt" rows="2" cols="100"></textarea>

        <label>Draft:</label>
        <textarea name="draft" rows="6" cols="100"></textarea>

        <button type="submit" name="save_draft_only" value="1">Add Draft</button>
    </form>

    {% include 'chat_widget.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // Debugging initialization
            console.log('Document loaded, initializing essay analysis...');
            
            // Get CSRF token - works with Django's default templates
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             document.querySelector('meta[name="csrf-token"]')?.content;
            
            if (!csrftoken) {
                console.error('CSRF token not found! Check your template tags.');
                return;
            } else {
                console.log('CSRF token found:', csrftoken.slice(0, 10) + '...');
            }
        
            // Main analysis function
            async function analyzeEssayContent(element) {
                console.log('Starting analysis...');
                
                const originalContent = element.innerHTML;
                const textContent = element.innerText.trim();
                
                if (textContent.length < 10) {
                    console.log('Text too short for analysis');
                    return;
                }
                
                // Show loading state
                element.innerHTML = originalContent + 
                    '<div style="color:#999; padding:5px;">Analyzing essay... (this may take 10-20 seconds)</div>';
                
                try {
                    console.log('Sending request with text:', textContent.slice(0, 50) + '...');
                    
                    const startTime = performance.now();
                    const response = await fetch("{% url 'counselor:analyze_essay' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                            "X-Requested-With": "XMLHttpRequest"
                        },
                        body: JSON.stringify({ 
                            text: textContent,
                            application_id: element.closest('form')?.querySelector('[name="edit_draft_id"]')?.value
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const duration = ((performance.now() - startTime)/1000).toFixed(2);
                    console.log(`Analysis completed in ${duration}s`, data);
                    
                    if (!data.highlights || data.highlights.length === 0) {
                        element.innerHTML = originalContent;
                        console.log('No highlights returned from analysis');
                        return;
                    }
                    
                    // Process highlights while preserving HTML structure
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = originalContent;
                    
                    // Case-insensitive highlight without breaking HTML
                    data.highlights.forEach(item => {
                        const regex = new RegExp(escapeRegExp(item.text), 'gi');
                        highlightTextNodes(tempDiv, regex, item.suggestion);
                    });
                    
                    element.innerHTML = tempDiv.innerHTML;
                    initTooltips();
                    
                } catch (error) {
                    console.error('Analysis failed:', error);
                    element.innerHTML = originalContent;
                    
                    // Show error to user
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'red';
                    errorDiv.style.padding = '5px';
                    errorDiv.textContent = 'Analysis failed. Please try again.';
                    element.parentNode.insertBefore(errorDiv, element.nextSibling);
                    
                    setTimeout(() => errorDiv.remove(), 5000);
                }
            }
        
            // Helper function to highlight text nodes
            function highlightTextNodes(element, regex, suggestion) {
                const treeWalker = document.createTreeWalker(
                    element, 
                    NodeFilter.SHOW_TEXT, 
                    { acceptNode: node => 
                        node.nodeValue.trim().length > 0 ? 
                        NodeFilter.FILTER_ACCEPT : 
                        NodeFilter.FILTER_REJECT 
                    }
                );
                
                const textNodes = [];
                while(treeWalker.nextNode()) textNodes.push(treeWalker.currentNode);
                
                textNodes.forEach(textNode => {
                    const newHtml = textNode.nodeValue.replace(
                        regex,
                        match => `<span class="highlight-tooltip" title="${escapeHtml(suggestion)}">${match}</span>`
                    );
                    
                    if (newHtml !== textNode.nodeValue) {
                        const wrapper = document.createElement('span');
                        wrapper.innerHTML = newHtml;
                        textNode.parentNode.replaceChild(wrapper, textNode);
                    }
                });
            }
        
            // Initialize tooltip hover effects
            function initTooltips() {
                document.querySelectorAll('.highlight-tooltip').forEach(tooltip => {
                    tooltip.addEventListener('mouseenter', showTooltip);
                    tooltip.addEventListener('mouseleave', hideTooltip);
                });
            }
        
            function showTooltip(event) {
                const tooltip = document.createElement('div');
                tooltip.className = 'active-tooltip';
                tooltip.textContent = this.title;
                
                // Position tooltip above the highlight
                const rect = this.getBoundingClientRect();
                tooltip.style.position = 'fixed';
                tooltip.style.left = `${rect.left + window.scrollX}px`;
                tooltip.style.top = `${rect.top + window.scrollY - 5}px`;
                tooltip.style.transform = 'translateY(-100%)';
                
                document.body.appendChild(tooltip);
            }
        
            function hideTooltip() {
                document.querySelectorAll('.active-tooltip').forEach(t => t.remove());
            }
        
            // Utility functions
            function escapeRegExp(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        
            // Set up event listeners
            document.querySelectorAll('.essay-feedback').forEach(div => {
                // Blur event for automatic analysis
                div.addEventListener('blur', function() {
                    if (!this.dataset.noAutoAnalyze) {
                        analyzeEssayContent(this);
                    }
                });
                
                // Manual analysis button (fallback)
                const analyzeBtn = document.createElement('button');
                analyzeBtn.className = 'analyze-btn';
                analyzeBtn.textContent = 'Analyze Essay';
                analyzeBtn.style.marginTop = '10px';
                analyzeBtn.onclick = () => analyzeEssayContent(div);
                
                div.insertAdjacentElement('afterend', analyzeBtn);
            });
        
            console.log('Essay analysis initialized successfully');
        });
        </script>
        
        <style>
        .highlight-tooltip {
            background-color: #FFF9C4;
            border-bottom: 2px dotted #FFA000;
            position: relative;
            cursor: help;
        }
        
        .active-tooltip {
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            max-width: 300px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            pointer-events: none;
        }
        
        .analyze-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .analyze-btn:hover {
            background: #388E3C;
        }
        </style>
</body>
</html>